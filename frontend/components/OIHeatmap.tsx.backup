import { useState, useEffect } from 'react';
import { BarChart3, TrendingUp, TrendingDown, Calendar } from 'lucide-react';
import axios from 'axios';

interface OIData {
  strike: number;
  oi: number;
  change: number;
  ltp: number;
  volume: number;
  iv: number;
  put_oi: number;
  put_change: number;
  put_ltp: number;
  put_volume: number;
  put_iv: number;
}

interface ExpiryDate {
  date: string;
  label: string;
  isCurrent: boolean;
}

interface OIHeatmapProps {
  symbol: string;
}

export default function OIHeatmap({ symbol }: OIHeatmapProps) {
  const [oiData, setOiData] = useState<OIData[]>([]);
  const [loading, setLoading] = useState<boolean>(false);
  const [spotPrice, setSpotPrice] = useState<number | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [totalCallOI, setTotalCallOI] = useState<number>(0);
  const [totalPutOI, setTotalPutOI] = useState<number>(0);
  const [putCallRatio, setPutCallRatio] = useState<number>(0);
  const [expiryLoading, setExpiryLoading] = useState<boolean>(false);
  const [availableExpiries, setAvailableExpiries] = useState<ExpiryDate[]>([]);
  const [selectedExpiry, setSelectedExpiry] = useState<string>('');

  // Fetch available expiry dates
  const fetchAvailableExpiries = async () => {
    try {
      setExpiryLoading(true);
      const response = await axios.get(`http://localhost:8000/api/v1/options/contract/${symbol}`);
      
      console.log('Expiry response:', response.data); // Debug log
      
      // Handle different response formats
      let expiryDates: string[] = [];
      if (response.data && response.data.data && Array.isArray(response.data.data)) {
        expiryDates = response.data.data;
      } else if (response.data && Array.isArray(response.data)) {
        expiryDates = response.data;
      } else {
        console.error('Unexpected response format:', response.data);
      }
      
      const expiries: ExpiryDate[] = expiryDates.map((date: string) => {
        const expiryDate = new Date(date);
        const today = new Date();
        
        // Calculate if this is the current/near expiry
        const daysUntilExpiry = Math.ceil((expiryDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
        const isCurrent = daysUntilExpiry >= 0 && daysUntilExpiry <= 7; // Within next week
        
        return {
          date,
          label: formatExpiryDate(date),
          isCurrent
        };
      });
      
      setAvailableExpiries(expiries);
      
      // Auto-select nearest expiry if none selected
      if (!selectedExpiry && expiries.length > 0) {
        // Prioritize current expiries (within next week)
        const currentExpiry = expiries.find(e => e.isCurrent);
        const nearestExpiry = currentExpiry || expiries[0];
        console.log('Auto-selecting expiry:', nearestExpiry.date, nearestExpiry.label);
        setSelectedExpiry(nearestExpiry.date);
      }
      
      console.log('Available expiries:', expiries); // Debug log
      console.log('Selected expiry:', selectedExpiry); // Debug log
      
    } catch (err) {
      console.error('Error fetching expiries:', err);
      setError('Failed to fetch expiry dates');
    } finally {
      setExpiryLoading(false);
    }
  };

  // Format expiry date for display
  const formatExpiryDate = (dateString: string) => {
    const date = new Date(dateString);
    const today = new Date();
    
    // Calculate days until expiry
    const daysUntilExpiry = Math.ceil((date.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
    
    if (date.toDateString() === today.toDateString()) {
      return 'Today';
    } else if (date.toDateString() === new Date(today.getTime() + 24 * 60 * 60 * 1000).toDateString()) {
      return 'Tomorrow';
    } else if (daysUntilExpiry > 0 && daysUntilExpiry <= 7) {
      return `${daysUntilExpiry} days`;
    } else if (daysUntilExpiry > 7 && daysUntilExpiry <= 14) {
      // Show "X weeks" for expiries 2-4 weeks away
      const weeks = Math.floor(daysUntilExpiry / 7);
      return `${weeks} week${weeks > 1 ? 's' : ''}`;
    } else {
      // Show formatted date for longer expiries
      return date.toLocaleDateString('en-IN', { 
        day: 'numeric', 
        month: 'short', 
        year: '2-digit'  // Short year format
      });
    }
  };

  // Validate expiry date
  const isValidExpiry = (dateString: string) => {
    const date = new Date(dateString);
    const today = new Date();
    
    // Check if date is valid and in the future
    return !isNaN(date.getTime()) && date >= today;
  };

  // Handle expiry selection
  const handleExpiryChange = (expiry: string) => {
    if (isValidExpiry(expiry)) {
      setSelectedExpiry(expiry);
    } else {
      console.error('Invalid expiry date selected:', expiry);
    }
  };
  // Fetch expiries on component mount
  useEffect(() => {
    fetchAvailableExpiries();
  }, [symbol]);

  // Fetch option chain data
  useEffect(() => {
    // Only fetch if we have a selected expiry
    if (selectedExpiry) {
      const fetchOptionChain = async () => {
        try {
          setLoading(true);
          setError(null);
          
          console.log("Fetching option chain with expiry:", selectedExpiry);
          const response = await axios.get(
            `http://localhost:8000/api/v1/options/chain/${symbol}?expiry_date=${selectedExpiry}`
          );
        
          console.log("BACKEND OPTION CHAIN:", response.data);
          console.log("FULL RESPONSE STRUCTURE:", JSON.stringify(response.data, null, 2));
          
          const chain = response.data;
          
          // Backend returns: {status: "success", data: {symbol, expiry, calls, puts}}
          const calls = chain?.data?.calls || [];
          const puts = chain?.data?.puts || [];
          
          console.log("=== DEBUG: First 3 calls ===");
          console.table(calls?.slice(0, 3));
          console.log("=== DEBUG: First 3 puts ===");
          console.table(puts?.slice(0, 3));
          console.log("=== DEBUG: Expected data path: chain.data.calls ===");
          console.log("=== DEBUG: Actual calls path:", chain?.data?.calls);
          console.log("=== DEBUG: Backend 25600 strike data:", calls.find(c => c.strike === 25600));
          console.log("=== DEBUG: Backend 25600 OI:", calls.find(c => c.strike === 25600)?.oi);
        
          const transformedData = calls.map((call: any) => {
            const matchingPut = puts.find(
              (p: any) => p.strike === call.strike
            );
        
            return {
              strike: call.strike,
              oi: call.oi || 0,
              change: call.change || 0,
              ltp: call.ltp || 0,
              volume: call.volume || 0,
              iv: call.iv || 0,
              put_oi: matchingPut?.oi || 0,
              put_change: matchingPut?.change || 0,
              put_ltp: matchingPut?.ltp || 0,
              put_volume: matchingPut?.volume || 0,
              put_iv: matchingPut?.iv || 0
            };
          });
        
          setOiData(transformedData);
        
        } catch (err: any) {
          console.error("AXIOS ERROR FULL:", err);
          console.error("AXIOS RESPONSE:", err?.response);
          console.error("AXIOS STATUS:", err?.response?.status);
          console.error("AXIOS DATA:", err?.response?.data);
          
          // Handle rate limit specifically
          if (err?.response?.status === 429) {
            console.warn("Rate limit exceeded - waiting longer before retry");
            setError("Rate limit exceeded - please wait");
            return;
          }
          
          setError("Failed to fetch option chain data");
        } finally {
          setLoading(false);
        }
      };
      
      fetchOptionChain();
    }
  }, [symbol, selectedExpiry]);

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="loading-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="metric-card">
        <div className="flex items-center justify-center h-96">
          <div className="text-center">
            <h3 className="text-xl font-semibold text-danger-500">Error</h3>
            <p className="text-muted-foreground">{error}</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="metric-card">
      <div className="flex items-center justify-between mb-6">
        <h3 className="text-xl font-semibold">OI Heatmap - {symbol}</h3>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2 text-sm">
            <div className="w-3 h-3 bg-danger-500 rounded"></div>
            <span className="text-muted-foreground">Call OI</span>
          </div>
          <div className="flex items-center gap-2 text-sm">
            <div className="w-3 h-3 bg-success-500 rounded"></div>
            <span className="text-muted-foreground">Put OI</span>
          </div>
        </div>
      </div>

      {/* Expiry Selector */}
      <div className="mb-4 p-3 glass-morphism rounded-lg">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Calendar className="w-4 h-4 text-muted-foreground" />
            <span className="text-sm text-muted-foreground">Expiry Date</span>
          </div>
          <div className="flex items-center gap-2">
            {expiryLoading ? (
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <span className="text-sm text-blue-500">Loading expiries...</span>
              </div>
            ) : availableExpiries.length > 0 ? (
              <div className="flex items-center gap-2">
                <select
                  value={selectedExpiry}
                  onChange={(e) => handleExpiryChange(e.target.value)}
                  className="bg-background border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-32"
                  disabled={loading}
                >
                  {availableExpiries.map((expiry) => (
                    <option key={expiry.date} value={expiry.date}>
                      {expiry.label} {expiry.isCurrent && '(Current)'}
                    </option>
                  ))}
                </select>
                {selectedExpiry && (
                  <span className="text-xs text-muted-foreground">
                    {formatExpiryDate(selectedExpiry)}
                  </span>
                )}
              </div>
            ) : (
              <span className="text-sm text-muted-foreground">No expiries available</span>
            )}
          </div>
        </div>
      </div>

      {/* Current Price Indicator */}
      <div className="mb-4 p-3 glass-morphism rounded-lg">
        <div className="flex items-center justify-between">
          <span className="text-sm text-muted-foreground">Current Price</span>
          <span className="text-lg font-bold">
            {spotPrice ? `₹${spotPrice.toLocaleString('en-IN')}` : '₹--'}
          </span>
        </div>
      </div>

      {/* OI Heatmap Table */}
      <div className="overflow-x-auto overflow-y-auto max-h-96">
        <table className="w-full">
          <thead>
            <tr className="text-left text-sm text-muted-foreground border-b border-white/10">
                    {row.oi.toLocaleString('en-IN')}
                  </div>
                </td>
                
                {/* Call Change */}
                <td className="py-3 text-center">
                  <div className={`px-2 py-1 rounded text-xs font-medium ${
                    row.change > 0 ? 'bg-success-500/20 text-success-500' :
                    row.change < 0 ? 'bg-danger-500/20 text-danger-500' :
                    'bg-gray-500/20 text-gray-300'
                  }`}>
                    {row.change?.toLocaleString('en-IN')}
                  </div>
                </td>
                
                {/* Call LTP */}
                <td className="py-3 text-center text-sm">
                  {row.ltp?.toLocaleString('en-IN', {
                    style: 'currency',
                    currency: 'INR'
                  })}
                </td>
                
                {/* Put LTP */}
                <td className="py-3 text-center text-sm">
                  {row.put_ltp?.toLocaleString('en-IN', {
                    style: 'currency',
                    currency: 'INR'
                  })}
                </td>
                
                {/* Put Change */}
                <td className="py-3 text-center">
                  <div className={`px-2 py-1 rounded text-xs font-medium ${
                    row.put_change > 0 ? 'bg-success-500/20 text-success-500' :
                    row.put_change < 0 ? 'bg-danger-500/20 text-danger-500' :
                    'bg-gray-500/20 text-gray-300'
                  }`}>
                    {row.put_change?.toLocaleString('en-IN')}
                  </div>
                </td>
                
                {/* Put OI with heatmap */}
                <td className="py-3 text-center">
                  <div 
                    className="px-2 py-1 rounded text-xs font-medium text-white oi-heatmap-cell"
                    style={{ backgroundColor: 'rgba(34, 197, 94, 0.5)' }}
                  >
                    {row.put_oi.toLocaleString('en-IN')}
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* OI Analysis Summary */}
      <div className="mt-6 pt-6 border-t border-white/10">
        <div className="grid grid-cols-3 gap-4">
          <div className="text-center">
            <div className="text-lg font-bold text-danger-500">
              {(totalCallOI / 10000000).toFixed(2)} Cr
            </div>
            <div className="text-xs text-muted-foreground">Total Call OI</div>
          </div>
          <div className="text-center">
            <div className="text-lg font-bold text-success-500">
              {(totalPutOI / 10000000).toFixed(2)} Cr
            </div>
            <div className="text-xs text-muted-foreground">Total Put OI</div>
          </div>
          <div className="text-center">
            <div className="text-lg font-bold text-primary-500">
              {putCallRatio.toFixed(2)}
            </div>
            <div className="text-xs text-muted-foreground">Put-Call Ratio</div>
          </div>
        </div>
      </div>

      {/* Legend */}
      <div className="mt-4 pt-4 border-t border-white/10">
        <div className="font-medium mb-2">Interpretation:</div>
        <div>• Darker colors indicate higher Open Interest</div>
        <div>• Green changes show OI addition, Red shows OI reduction</div>
        <div>• High Call OI at strikes above spot = Resistance</div>
        <div>• High Put OI at strikes below spot = Support</div>
      </div>
    </div>
  );
}
